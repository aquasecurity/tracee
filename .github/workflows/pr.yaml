#
# When a PR is opened or updated: Run Tracee Tests
#
name: PR
on:
  workflow_dispatch:
    inputs:
      tracee_ref:
        description: 'Tracee ref to checkout'
        required: true
        default: 'main'
        type: string

  pull_request:
    branches:
      - "main"
      - "release-v*.*"
    paths:
      - "!docs/**"
      - "!deploy/**"
      - "!packaging/**"
      - "!**.yaml"
      - "!**.md"
      - "!**.txt"
      - "!**.conf"
      # override previous rules:
      - "docs/docs/flags/**"
      - "docs/man/**"
      - "go.mod"
      - "go.sum"
      - "Makefile"
      - "**.c"
      - "**.h"
      - "**.go"
      - "**.sh"
      - "**/pr.yaml"
      - "**/action.yaml"
concurrency:
  group: ${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true
env:
  TRACEE_REF: ${{ github.event.inputs.tracee_ref || github.ref }}
  TESTS: >
    TRC-102
    TRC-103
    TRC-104
    TRC-105
    TRC-107
    TRC-1010
    TRC-1014
    TRC-1016
    TRC-1018
    TRC-1022
  ARM64_TESTS: >
    TRC-102
    TRC-103
    TRC-104
    TRC-105
    TRC-107
    TRC-1010
    TRC-1014
    TRC-1016
    TRC-1018
  NETTESTS: >
    IPv4
    IPv6
    TCP
    UDP
    ICMP
    ICMPv6
    DNS
    HTTP
    HTTPRequest
    HTTPResponse
jobs:
  debug-runner-label:
    name: Debug Runner Label
    runs-on: ubuntu-24.04
    steps:
      - name: Debug Runner Label
        run: |
          echo "Runner label: ${{ vars.UBUNTU_X86_RUNNER_LABEL }}"
  #
  # DOC VERIFICATION
  #
  verify-docs:
    name: Verify Documentation
    runs-on: ${{ vars.UBUNTU_X86_RUNNER_LABEL || 'ubuntu-24.04' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          ref: ${{ env.TRACEE_REF }}
      - name: Ensure updates of *.1.md and *.1 pairs
        run: |
          ./scripts/verify_man_md_sync.sh --base-ref origin/main --fetch-depth 1
  #
  # CODE VERIFICATION
  #
  verify-analyze-code:
    name: Verify and Analyze Code
    runs-on: ${{ vars.UBUNTU_X86_RUNNER_LABEL || 'ubuntu-24.04' }}
    container:
      image: alpine/git:2.49.1@sha256:bd54f921f6d803dfa3a4fe14b7defe36df1b71349a3e416547e333aa960f86e3
    steps:
      - name: Checkout Code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          submodules: true
          ref: ${{ env.TRACEE_REF }}
      - name: Setup Tracee
        uses: ./.github/actions/setup-tracee-alpine
      - name: Lint
        run: |
          if test -z "$(gofmt -l .)"; then
            echo "Congrats! There is nothing to fix."
          else
            echo "The following lines should be fixed."
            gofmt -s -d .
            exit 1
          fi
      - name: Lint (Revive)
        run: |
          make check-lint
      - name: Check Code Style
        run: |
          make check-fmt
      - name: Check Golang Vet
        run: |
          make check-vet
      - name: Check with StaticCheck
        run: |
          make check-staticcheck
      - name: Check with errcheck
        run: |
          make check-err
  #
  # TOOLS BUILD VERIFICATION
  #
  verify-tools:
    name: Verify Other Tools
    needs:
      - verify-analyze-code
    runs-on: ${{ vars.UBUNTU_X86_RUNNER_LABEL || 'ubuntu-24.04' }}
    container:
      image: alpine/git:2.49.1@sha256:bd54f921f6d803dfa3a4fe14b7defe36df1b71349a3e416547e333aa960f86e3
    steps:
      - name: Checkout Code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          submodules: true
          ref: ${{ env.TRACEE_REF }}
      - name: Setup Tracee
        uses: ./.github/actions/setup-tracee-alpine
      - name: Build Tracee Benchmark Tool
        run: |
          make clean
          make tracee-bench
      - name: Build E2E Network Signatures
        run: |
          make clean
          make e2e-net-signatures
      - name: Build E2E Instrumentation Signatures
        run: |
          make clean
          make e2e-inst-signatures
  #
  # CHANGE DETECTION (CENTRALIZED)
  #
  detect-changes:
    name: Detect Changes
    runs-on: ${{ vars.UBUNTU_X86_RUNNER_LABEL || 'ubuntu-24.04' }}
    outputs:
      main: ${{ steps.detect.outputs.main }}
      types: ${{ steps.detect.outputs.types }}
      common: ${{ steps.detect.outputs.common }}
      api: ${{ steps.detect.outputs.api }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          ref: ${{ env.TRACEE_REF }}
          fetch-depth: 0
      - name: Fix Git ownership
        run: git config --global --add safe.directory $GITHUB_WORKSPACE
      - name: Detect Changes
        id: detect
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "Running via workflow_dispatch - setting all modules to true"
            echo "main=true" >> ${GITHUB_OUTPUT}
            echo "types=true" >> ${GITHUB_OUTPUT}
            echo "common=true" >> ${GITHUB_OUTPUT}
            echo "api=true" >> ${GITHUB_OUTPUT}
            exit 0
          fi
          
          # Get changed files using git (conventional approach)
          CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD)
          echo "Changed files:"
          echo "$CHANGED_FILES"
          # Check if main module changed (anything outside types/, common/, api/)
          if echo "$CHANGED_FILES" | grep -qvE '^(types|common|api)/'; then
            echo "main=true" >> $GITHUB_OUTPUT
            echo "Main module changed"
          else
            echo "main=false" >> $GITHUB_OUTPUT
            echo "No main module changes"
          fi
          # Check individual modules
          if echo "$CHANGED_FILES" | grep -q "^types/"; then
            echo "types=true" >> $GITHUB_OUTPUT
            echo "Types module changed"
          else
            echo "types=false" >> $GITHUB_OUTPUT
          fi
          if echo "$CHANGED_FILES" | grep -q "^common/"; then
            echo "common=true" >> $GITHUB_OUTPUT
            echo "Common module changed"
          else
            echo "common=false" >> $GITHUB_OUTPUT
          fi
          if echo "$CHANGED_FILES" | grep -q "^api/"; then
            echo "api=true" >> $GITHUB_OUTPUT
            echo "API module changed"
          else
            echo "api=false" >> $GITHUB_OUTPUT
          fi
  #
  # MODULE TESTS
  #
  test-modules:
    name: Go Modules Unit Tests (x86_64)
    needs:
      - detect-changes
    if: needs.detect-changes.outputs.main != 'true'
    runs-on: ${{ vars.UBUNTU_X86_RUNNER_LABEL || 'ubuntu-24.04' }}
    container:
      image: alpine/git:2.49.1@sha256:bd54f921f6d803dfa3a4fe14b7defe36df1b71349a3e416547e333aa960f86e3
    steps:
      - name: Checkout Code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          ref: ${{ env.TRACEE_REF }}
          fetch-depth: 0
      - name: Setup Tracee
        uses: ./.github/actions/setup-tracee-alpine
      - name: Test Types Module
        if: needs.detect-changes.outputs.types == 'true'
        uses: ./.github/actions/test-go-module
        with:
          module-name: 'types'
          working-directory: './types'

      - name: Test Common Module
        if: needs.detect-changes.outputs.common == 'true'
        uses: ./.github/actions/test-go-module
        with:
          module-name: 'common'
          working-directory: './common'

      - name: Test API Module
        if: needs.detect-changes.outputs.api == 'true'
        uses: ./.github/actions/test-go-module
        with:
          module-name: 'api'
          working-directory: './api'

  test-modules-arm64:
    name: Go Modules Unit Tests (ARM64)
    needs:
      - detect-changes
    if: needs.detect-changes.outputs.main != 'true'
    runs-on: ${{ vars.UBUNTU_ARM64_RUNNER_LABEL || 'ubuntu-24.04-arm' }}
    container:
      image: alpine/git:2.49.1@sha256:bd54f921f6d803dfa3a4fe14b7defe36df1b71349a3e416547e333aa960f86e3
      volumes:
        - /opt:/opt:rw,rshared
        # The following volume mount is a workaround for GitHub Actions runner limitations.
        # Some GitHub-hosted runners expect Node.js to be available at /__e/node20, which is not present in the base container.
        # This mapping provides Node.js from the host's /opt directory to the expected location in the container.
        # WARNING: This creates a fragile dependency on the runner's internal filesystem layout.
        # If the runner environment changes, this workflow may break. Consider updating this step if a more robust solution becomes available.
        - /opt:/__e/node20:ro,rshared
    steps:
      - name: Allow Linux musl containers on ARM64 runners
        run: |
          sed -i "/^ID=/s/alpine/NotpineForGHA/" /etc/os-release
          apk add nodejs --update-cache
          mkdir -p /opt/bin
          ln -s /usr/bin/node /opt/bin/node
        shell: sh
      - name: Checkout Code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          ref: ${{ env.TRACEE_REF }}
          fetch-depth: 0
      - name: Setup Tracee
        uses: ./.github/actions/setup-tracee-alpine
      - name: Test Types Module
        if: needs.detect-changes.outputs.types == 'true'
        uses: ./.github/actions/test-go-module
        with:
          module-name: 'types (ARM64)'
          working-directory: './types'

      - name: Test Common Module
        if: needs.detect-changes.outputs.common == 'true'
        uses: ./.github/actions/test-go-module
        with:
          module-name: 'common (ARM64)'
          working-directory: './common'

      - name: Test API Module
        if: needs.detect-changes.outputs.api == 'true'
        uses: ./.github/actions/test-go-module
        with:
          module-name: 'api (ARM64)'
          working-directory: './api'

  #
  # CODE TESTS
  #
  unit-tests:
    name: Full Unit Tests (x86_64)
    needs:
      - verify-analyze-code
      - detect-changes
    if: needs.detect-changes.outputs.main == 'true'
    runs-on: ${{ vars.UBUNTU_X86_RUNNER_LABEL || 'ubuntu-24.04' }}
    container:
      image: alpine/git:2.49.1@sha256:bd54f921f6d803dfa3a4fe14b7defe36df1b71349a3e416547e333aa960f86e3
    steps:
      - name: Checkout Code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          submodules: true
          ref: ${{ env.TRACEE_REF }}
          fetch-depth: 0  # Fetch full history for codecov base comparison
      - name: Setup Tracee
        uses: ./.github/actions/setup-tracee-alpine
      - name: Run Unit Tests
        uses: ./.github/actions/run-unit-tests
        with:
          codecov-token: ${{ secrets.CODECOV_TOKEN }}

  unit-tests-arm64:
    name: Full Unit Tests (ARM64)
    needs:
      - verify-analyze-code
      - detect-changes
    if: needs.detect-changes.outputs.main == 'true'
    runs-on: ${{ vars.UBUNTU_ARM64_RUNNER_LABEL || 'ubuntu-24.04-arm' }}
    container:
      image: alpine/git:2.49.1@sha256:bd54f921f6d803dfa3a4fe14b7defe36df1b71349a3e416547e333aa960f86e3
      volumes:
        - /opt:/opt:rw,rshared
        # The following volume mount is a workaround for GitHub Actions runner limitations.
        # Some GitHub-hosted runners expect Node.js to be available at /__e/node20, which is not present in the base container.
        # This mapping provides Node.js from the host's /opt directory to the expected location in the container.
        # WARNING: This creates a fragile dependency on the runner's internal filesystem layout.
        # If the runner environment changes, this workflow may break. Consider updating this step if a more robust solution becomes available.
        - /opt:/__e/node20:ro,rshared
    steps:
      - name: Allow Linux musl containers on ARM64 runners
        run: |
          sed -i "/^ID=/s/alpine/NotpineForGHA/" /etc/os-release
          apk add nodejs --update-cache
          mkdir -p /opt/bin
          ln -s /usr/bin/node /opt/bin/node
        shell: sh
      - name: Checkout Code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          submodules: true
          ref: ${{ env.TRACEE_REF }}
          fetch-depth: 0  # Fetch full history for codecov base comparison
      - name: Setup Tracee
        uses: ./.github/actions/setup-tracee-alpine
      - name: Run Unit Tests
        uses: ./.github/actions/run-unit-tests
        with:
          codecov-token: ${{ secrets.CODECOV_TOKEN }}
  #
  # INTEGRATION TESTS
  #
  integration-tests:
    name: Integration Tests (x86_64)
    needs:
      - verify-analyze-code
      - detect-changes
    if: needs.detect-changes.outputs.main == 'true'
    runs-on:
      - graas_ami-0e38f3caba1b4234d_${{ github.event.number }}${{ github.run_attempt }}-${{ github.run_id }}_${{ github.run_number }}123 # Noble 6.12 x86_64 GRAAS AMI
      - EXECUTION_TYPE=SHORT
      - INSTANCE_TYPE=MEDIUM
    container:
      image: ubuntu:24.04@sha256:353675e2a41babd526e2b837d7ec780c2a05bca0164f7ea5dbbd433d21d166fc
      options: --pid=host --cgroupns=host --privileged -v /etc/os-release:/etc/os-release-host:ro -v /var/run:/var/run:ro -v /sys/kernel/debug:/sys/kernel/debug:rw -v /boot:/boot:ro
    steps:
      - name: Install Git
        run: |
          export DEBIAN_FRONTEND=noninteractive
          apt-get update
          apt-get install -y --no-install-recommends git-core ca-certificates
          update-ca-certificates
      - name: Checkout Code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          submodules: true
          ref: ${{ env.TRACEE_REF }}
          fetch-depth: 0  # Fetch full history for codecov base comparison
      - name: Fix Git ownership
        run: git config --global --add safe.directory $GITHUB_WORKSPACE
      - name: Setup Tracee
        uses: ./.github/actions/setup-tracee-ubuntu
      - name: Pull test images
        uses: ./.github/actions/pull-test-images
      - name: Run Integration Tests
        uses: ./.github/actions/run-integration-tests
        with:
          codecov-token: ${{ secrets.CODECOV_TOKEN }}
  integration-tests-arm64:
    name: Integration Tests (ARM64)
    needs:
      - verify-analyze-code
      - detect-changes
    if: needs.detect-changes.outputs.main == 'true'
    runs-on:
      - graas_ami-0547f429681dc1f2a_${{ github.event.number }}${{ github.run_attempt }}-${{ github.run_id }}_${{ github.run_number }} # Noble 6.12 aarch64 GRAAS AMI
      - EXECUTION_TYPE=SHORT
      - INSTANCE_TYPE=MEDIUM
    container:
      image: ubuntu:24.04@sha256:353675e2a41babd526e2b837d7ec780c2a05bca0164f7ea5dbbd433d21d166fc
      options: --pid=host --cgroupns=host --privileged -v /etc/os-release:/etc/os-release-host:ro -v /var/run:/var/run:ro -v /sys/kernel/debug:/sys/kernel/debug:rw -v /boot:/boot:ro
    steps:
      - name: Install Git
        run: |
          export DEBIAN_FRONTEND=noninteractive
          apt-get update
          apt-get install -y --no-install-recommends git-core ca-certificates
          update-ca-certificates
      - name: Checkout Code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          submodules: true
          ref: ${{ env.TRACEE_REF }}
          fetch-depth: 0  # Fetch full history for codecov base comparison
      - name: Fix Git ownership
        run: git config --global --add safe.directory $GITHUB_WORKSPACE
      - name: Setup Tracee
        uses: ./.github/actions/setup-tracee-ubuntu
      - name: Pull test images
        uses: ./.github/actions/pull-test-images
      - name: Run Integration Tests
        uses: ./.github/actions/run-integration-tests
        with:
          codecov-token: ${{ secrets.CODECOV_TOKEN }}
  #
  # PERFORMANCE TESTS
  #
  performance-tests:
    name: Performance Tests
    needs:
      - verify-analyze-code
      - detect-changes
    if: needs.detect-changes.outputs.main == 'true'
    runs-on: ${{ vars.UBUNTU_X86_RUNNER_LABEL || 'ubuntu-24.04' }}
    container:
      image: alpine/git:2.49.1@sha256:bd54f921f6d803dfa3a4fe14b7defe36df1b71349a3e416547e333aa960f86e3
      options: --pid=host --cgroupns=host --privileged -v /etc/os-release:/etc/os-release-host:ro -v /var/run:/var/run:ro
    steps:
      - name: Checkout Code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          submodules: true
          ref: ${{ env.TRACEE_REF }}
      - name: Setup Tracee
        uses: ./.github/actions/setup-tracee-alpine
      - name: Run Performance Tests
        run: |
          make test-performance
  #
  # FUNCTIONAL TESTS AGAINST DIFFERENT KERNELS
  #
  generate-matrix:
    name: Generate Test Matrix
    needs:
      - detect-changes
    runs-on: ${{ vars.UBUNTU_X86_RUNNER_LABEL || 'ubuntu-24.04' }}
    if: needs.detect-changes.outputs.main == 'true'
    outputs:
      matrix01: ${{ steps.generate.outputs.matrix }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          ref: ${{ env.TRACEE_REF }}
      - name: Generate Matrix
        id: generate
        uses: ./.github/actions/generate-kernel-matrix
  kernel-tests:
    name: ${{ matrix.job_name }}
    needs:
      - generate-matrix
    runs-on:
      - graas_ami-${{ matrix.ami }}_${{ github.event.number }}${{ github.run_attempt }}-${{ github.run_id }}_${{ matrix.sufix }}
      - EXECUTION_TYPE=LONG
      - INSTANCE_TYPE=XLARGE
    strategy:
      fail-fast: false
      matrix:
        include: ${{fromJson(needs.generate-matrix.outputs.matrix01)}}
    env:
      HOME: "/tmp/root"
      GOPATH: "/tmp/go"
      GOCACHE: "/tmp/go-cache"
      GOROOT: "/usr/local/go"
    steps:
      - name: "Checkout"
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          submodules: true
          ref: ${{ env.TRACEE_REF }}
      - name: "Environment Variables"
        run: |
          if [[ "${{ matrix.arch }}" == "aarch64" ]]; then
            echo "TESTS=${{ env.ARM64_TESTS }}" >> $GITHUB_ENV
          fi
          LINUX_ID=$(grep -Pom1 '^ID=\K.*' /etc/os-release)
          echo "LINUX_ID=${LINUX_ID}" >> ${GITHUB_ENV}
      - name: "Disable Unattended Upgrades (Ubuntu only)"
        if: ${{ env.LINUX_ID == 'ubuntu' }}
        run: ./scripts/disable-unattended-upgrades.sh --timeout 5
        continue-on-error: true
      # - name: "Prepare Image (Fix AMIs)"
      #   run: ./tests/e2e-install-deps.sh
      - name: Pull test images
        uses: ./.github/actions/pull-test-images
      - name: "Sync System Time"
        run: ./scripts/sync_system_time.sh
        continue-on-error: true
      - name: "Run E2E Tests"
        uses: ./.github/actions/run-e2e-tests
        with:
          job-name: ${{ matrix.job_name }}
          run-id: ${{ github.run_id }}
          run-attempt: ${{ github.run_attempt }}
