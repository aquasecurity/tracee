---
# The PR workflow is triggered automatically whenever a pull request (PR) is
# opened to the main branch. It's also triggered when a PR is updated by adding
# commits to the PR branch.
name: PR
on:
  pull_request:
    branches:
      - main
env:
  GO_VERSION: "1.17"
  OPA_VERSION: "v0.35.0"
jobs:
  verify-code:
    name: Verify Code
    runs-on: ubuntu-20.04
    steps:
      - name: Setup Go
        uses: actions/setup-go@v2
        with:
          go-version: ${{ env.GO_VERSION }}
      - name: Checkout Code
        uses: actions/checkout@v2
        with:
          submodules: true
      - name: Lint
        run: |
          if test -z "$(gofmt -l .)"; then
            echo "Congrats! There is nothing to fix."
          else
            echo "The following lines should be fixed."
            gofmt -s -d .
            exit 1
          fi

  run-unit-tests:
    name: "Run Unit Tests"
    runs-on: ubuntu-20.04
    steps:
      - name: Checkout Code
        uses: actions/checkout@v2
        with:
          submodules: true
      - name: Install Dependencies
        uses: ./.github/actions/build-dependencies
        with:
          go-version: ${{ env.GO_VERSION }}
          opa-version: ${{ env.OPA_VERSION }}
      - name: Run Unit Tests
        run: |
          make test-unit

  run-integration-tests:
    name: "Run Integration Tests"
    needs:
      - verify-code
      - run-unit-tests
    runs-on: ubuntu-20.04
    steps:
      - name: Checkout Code
        uses: actions/checkout@v2
        with:
          submodules: true
      - name: Install Dependencies
        uses: ./.github/actions/build-dependencies
        with:
          go-version: ${{ env.GO_VERSION }}
          opa-version: ${{ env.OPA_VERSION }}
      - name: Run Integration Tests
        run: |
          make test-integration

  verify-signatures:
    name: Verify Signatures
    needs:
      - verify-code
      - run-unit-tests
    runs-on: ubuntu-20.04
    steps:
      - name: Checkout Code
        uses: actions/checkout@v2
        with:
          submodules: true
      - name: Install Dependencies
        uses: ./.github/actions/build-dependencies
        with:
          go-version: ${{ env.GO_VERSION }}
          opa-version: ${{ env.OPA_VERSION }}
      - name: Build Signatures
        run: |
          make rules
      - name: Test Signatures
        run: |
          make test-rules

  # smoke-test-noncore job is using TRC-2 (Anti-Debugging) signature and tracee
  # non CO-RE container image to run a quick smoke test on each PR.
  #
  # NB: Ubuntu 20.04 provided by GitHub Actions runner does not support CO-RE.
  # Thus, we are running end-to-end signatures tests using tracee non CO-RE
  # container image.
  smoke-test-noncore:
    name: "[Smoke] Test non CO-RE"
    needs:
      - run-integration-tests
      - verify-signatures
    runs-on: ubuntu-20.04
    steps:
      - name: Checkout main
        uses: actions/checkout@v2
        with:
          submodules: true
      - name: Install Dependencies
        uses: ./.github/actions/build-dependencies
        with:
          go-version: ${{ env.GO_VERSION }}
          opa-version: ${{ env.OPA_VERSION }}
      - name: Build tracee image (full w/out BTFHUB)
        run: |
          BTFHUB=0 make -f builder/Makefile.tracee-container build-tracee-full
      - name: Install BPF
        run: |
          make install-bpf-nocore
      - name: Run tests
        run: |
          docker image pull aquasec/tracee-tester:latest
          go test -v -run "TestTraceeSignatures" ./tests/e2e/e2e_test.go \
            -tracee-image-ref "tracee:full" \
            -tracee-tester-image-ref "aquasec/tracee-tester:latest" \
            -tracee-signatures "TRC-2"

  # smoke-test-core job is using TRC-2 (Anti-Debugging) signature and tracee
  # CO-RE container image with embedded BTF info objects to run a quick smoke
  # test on each PR.
  smoke-test-core:
    name: "[Smoke] Test CO-RE"
    needs:
      - run-integration-tests
      - verify-signatures
    runs-on: ubuntu-20.04
    steps:
      - name: Checkout main
        uses: actions/checkout@v2
        with:
          submodules: true
      - name: Install Dependencies
        uses: ./.github/actions/build-dependencies
        with:
          go-version: ${{ env.GO_VERSION }}
          opa-version: ${{ env.OPA_VERSION }}
      - name: Built tracee BPF
        run: |
          make bpf-core
      - name: Build tracee image (slim w/ BTFHUB)
        run: |
          BTFHUB=1 make -f builder/Makefile.tracee-container build-tracee
      - name: Run tests
        run: |
          docker image pull aquasec/tracee-tester:latest
          go test -v -run "TestTraceeSignatures" ./tests/e2e/e2e_test.go \
            -tracee-image-ref "tracee:latest" \
            -tracee-tester-image-ref "aquasec/tracee-tester:latest" \
            -tracee-signatures "TRC-2"

  #
  # Tests TRC-2 with selected kernels.
  # Runs on a PR touching eBPF source codes.
  #
  # TODO: Automate tracee-test-kernels generation through workflows.
  # TODO: Change dockerhub -> github repository once we're sure this is good.
  #

  #
  # TRC-2 v4.19 (stable)
  #
  run-core-test-trc2-v419-stable:
    name: "TRC-2 v4.19 (stable)"
    needs:
      - smoke-test-core
    runs-on: ubuntu-latest
    env:
      TEST_NAME: TRC-2
    steps:
      #
      - name: "Checkout"
        uses: actions/checkout@main
        with:
          submodules: true
      #
      - name: "Pull test container image"
        run: |
          docker image pull rafaeldtinoco/tracee-test-kernels:latest
      #
      - name: "v4.19 (4.19.238-stable)"
        run: |
          kernel_version=4.19.238-stable
          docker run --rm --privileged -v $(pwd):/tracee:rw -e kvm_accel="tcg" -e kern_version="$kernel_version" -e test_name="$TEST_NAME" -t rafaeldtinoco/tracee-test-kernels:latest
  #
  # TRC-2 v5.4 (stable)
  #
  run-core-test-trc2-v54-stable:
    name: "TRC-2 v5.4 (stable)"
    needs:
      - smoke-test-core
    runs-on: ubuntu-latest
    env:
      TEST_NAME: TRC-2
    steps:
      #
      - name: "Checkout"
        uses: actions/checkout@main
        with:
          submodules: true
      #
      - name: "Pull test container image"
        run: |
          docker image pull rafaeldtinoco/tracee-test-kernels:latest
      #
      - name: "v5.4 (5.4.189-stable)"
        run: |
          kernel_version=5.4.189-stable
          docker run --rm --privileged -v $(pwd):/tracee:rw -e kvm_accel="tcg" -e kern_version="$kernel_version" -e test_name="$TEST_NAME" -t rafaeldtinoco/tracee-test-kernels:latest
  #
  # TRC-2 v5.8 (ubuntu)
  #
  run-core-test-trc2-v58-ubuntu:
    name: "TRC-2 v5.8 (ubuntu)"
    needs:
      - smoke-test-core
    runs-on: ubuntu-latest
    env:
      TEST_NAME: TRC-2
    steps:
      #
      - name: "Checkout"
        uses: actions/checkout@main
        with:
          submodules: true
      #
      - name: "Pull test container image"
        run: |
          docker image pull rafaeldtinoco/tracee-test-kernels:latest
      #
      - name: "v5.8 (5.8.18-ubuntu)"
        run: |
          kernel_version=5.8.18-ubuntu
          docker run --rm --privileged -v $(pwd):/tracee:rw -e kvm_accel="tcg" -e kern_version="$kernel_version" -e test_name="$TEST_NAME" -t rafaeldtinoco/tracee-test-kernels:latest
  #
  # TRC-2 v5.10 (stable)
  #
  run-core-test-trc2-v510-stable:
    name: "TRC-2 v5.10 (stable)"
    needs:
      - smoke-test-core
    runs-on: ubuntu-latest
    env:
      TEST_NAME: TRC-2
    steps:
      #
      - name: "Checkout"
        uses: actions/checkout@main
        with:
          submodules: true
      #
      - name: "Pull test container image"
        run: |
          docker image pull rafaeldtinoco/tracee-test-kernels:latest
      #
      - name: "v5.10 (5.10.111-stable)"
        run: |
          kernel_version=5.10.111-stable
          docker run --rm --privileged -v $(pwd):/tracee:rw -e kvm_accel="tcg" -e kern_version="$kernel_version" -e test_name="$TEST_NAME" -t rafaeldtinoco/tracee-test-kernels:latest
  #
  # TRC-2 v5.13 (ubuntu)
  #
  run-core-test-trc2-v513-ubuntu:
    name: "TRC-2 v5.13 (ubuntu)"
    needs:
      - smoke-test-core
    runs-on: ubuntu-latest
    env:
      TEST_NAME: TRC-2
    steps:
      #
      - name: "Checkout"
        uses: actions/checkout@main
        with:
          submodules: true
      #
      - name: "Pull test container image"
        run: |
          docker image pull rafaeldtinoco/tracee-test-kernels:latest
      #
      - name: "v5.13 (5.13.19-ubuntu)"
        run: |
          kernel_version=5.13.19-ubuntu
          docker run --rm --privileged -v $(pwd):/tracee:rw -e kvm_accel="tcg" -e kern_version="$kernel_version" -e test_name="$TEST_NAME" -t rafaeldtinoco/tracee-test-kernels:latest
