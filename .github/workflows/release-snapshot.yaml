---
# Release snapshot on CRON schedule or on demand. This workflow ensures that
# the main branch is ready for release and that all build configuration files
# are valid. Also scans tracee container images for vulnerabilities.
name: Release Snapshot

on:
  workflow_dispatch: {}
  schedule:
    - cron: "0 0 * * *"

env:
  GO_VERSION: "1.17"
  OPA_VERSION: "v0.35.0"
jobs:
  release-snapshot:
    name: Release Snapshot
    runs-on: ubuntu-20.04
    steps:
      - name: Checkout Code
        uses: actions/checkout@v2
        with:
          submodules: true
      - name: Install Dependencies
        uses: ./.github/actions/build-dependencies
        with:
          go-version: ${{ env.GO_VERSION }}
          opa-version: ${{ env.OPA_VERSION }}
      - name: Build
        run: |
          make -f builder/Makefile.release SNAPSHOT=1
      - name: Scan Docker Image for Vulnerabilities
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: "tracee:latest"
          severity: "CRITICAL"
          exit-code: "1"
      - name: Scan Docker Image for Vulnerabilities
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: "tracee:full"
          severity: "CRITICAL"
          exit-code: "1"
